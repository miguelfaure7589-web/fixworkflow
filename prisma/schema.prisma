generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Auth Models ───

model User {
  id                   String    @id @default(cuid())
  name                 String?
  email                String?   @unique
  emailVerified        DateTime?
  image                String?
  password             String?
  accounts             Account[]
  sessions             Session[]

  isAdmin              Boolean   @default(false)
  isPremium            Boolean   @default(false)
  stripeCustomerId     String?
  stripeSubscriptionId String?
  onboardingCompleted  Boolean   @default(false)
  diagnosisCompleted   Boolean   @default(false)
  frictionAreas        Json?
  toolPain             String?
  primaryGoal          String?
  freeTextChallenge    String?
  aiSummary            String?
  aiSummaryGeneratedAt DateTime?
  phone                String?
  notificationPrefs    Json?
  privacyPrefs         Json?
  previousScore        Int?
  scoreChangeReason    String?
  previousPillarScores Json?
  goals                Json?     // { monthlyRevenue?: number, grossMargin?: number, ... }
  avatarUrl            String?
  bio                  String?   @db.Text
  businessStage        String?
  profileGoal          String?
  referralSource       String?
  cancellationDate     DateTime?

  businessProfiles        BusinessProfile[]
  metricSnapshots         MetricSnapshot[]
  revenueHealthSnapshots  RevenueHealthSnapshot[]
  bottleneckAssessments   BottleneckAssessment[]
  insights                Insight[]

  revenueProfile          RevenueProfile?
  revenueScoreSnapshots   RevenueScoreSnapshot[]
  aiInsights              AiInsight[]
  playbookProgress        UserPlaybookProgress[]
  creditReferrals         CreditReferral[]

  integrations            Integration[]
  metricHistory           MetricHistory[]
  weeklyLogs              WeeklyLog[]
  feedback                Feedback[]
  reviews                 Review[]
  scoreAlerts             ScoreAlert[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ─── Core Platform Models ───

model Diagnosis {
  id        String   @id @default(cuid())
  userId    String?
  email     String?
  createdAt DateTime @default(now())

  // Diagnostic inputs
  role          String   // freelancer, solopreneur, remote_employee, team_lead
  industry      String
  teamSize      String
  workEnvironment String
  productivityScore Int
  frictionAreas String   // JSON array of selected friction areas
  currentTools  String   // JSON array of current tools
  detailedAnswers String // JSON object of drill-down answers

  // Results
  healthScore       Int?
  bottleneckScores  String?  // JSON: Record<category, score>
  recommendations   Recommendation[]
  status            String @default("pending") // pending, processing, completed

}

model Recommendation {
  id          String @id @default(cuid())
  diagnosisId String
  priority    String // high, medium, low
  category    String // lead_generation, conversion, retention, etc.
  title       String
  problem     String
  solution    String
  impact      String
  tools       String // JSON array of recommended tool slugs
  order       Int
  isPremium   Boolean @default(false)

  // V2 engine fields
  difficulty      Int?     // 1-5
  impactScore     Int?     // 1-5
  timeToImplement String?
  toolTags        String?  // JSON array of affiliate tool category tags
  resourceLinks   String?  // JSON array of resource suggestions
  aiInsight       String?  // AI-generated "why this matters" + "how to start"

  diagnosis Diagnosis @relation(fields: [diagnosisId], references: [id], onDelete: Cascade)
}

// ─── Tool & Affiliate Models ───

model Tool {
  id          String @id @default(cuid())
  slug        String @unique
  name        String
  description String
  category    String
  affiliateUrl String
  affiliateProgram String?
  commissionType String? // recurring, cpa
  commissionRate String?
  cookieWindow   String?
  hasFreeTier    Boolean @default(false)
  logoUrl        String?
  features       String  // JSON array
  bestFor        String  // JSON array of user types
  pricing        String?
  rating         Float?

  affiliateClicks AffiliateClick[]
}

model AccessoryProduct {
  id          String @id @default(cuid())
  slug        String @unique
  name        String
  description String
  category    String // laptop_stand, desk_organizer, bag, webcam, etc.
  affiliateUrl String
  imageUrl    String?
  price       String?
  bestFor     String // JSON array of user types
  isActive    Boolean @default(true)
  rotationGroup String? // for weekly rotation
}

model AffiliateClick {
  id          String   @id @default(cuid())
  userId      String?
  toolId      String?
  slug        String
  diagnosisId String?
  source      String?  // recommendation, comparison, email
  createdAt   DateTime @default(now())

  tool Tool? @relation(fields: [toolId], references: [id])
}

// ─── SEO & Comparison Models ───

model ComparisonPage {
  id          String @id @default(cuid())
  slug        String @unique // e.g., "clickup-vs-monday"
  tool1Slug   String
  tool2Slug   String
  title       String
  metaDescription String
  introText   String
  verdict     String
  isPublished Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model DiagnosticLandingPage {
  id              String @id @default(cuid())
  slug            String @unique // e.g., "project-management"
  title           String
  metaDescription String
  heroHeadline    String
  heroSubheadline String
  introText       String
  prefilledCategory String
  isPublished     Boolean @default(true)
}

model StackPage {
  id              String @id @default(cuid())
  slug            String @unique // e.g., "freelancer"
  role            String
  title           String
  metaDescription String
  introText       String
  recommendedTools String // JSON array of tool slugs
  isPublished     Boolean @default(true)
}

// ─── Revenue Intelligence Models ───

model BusinessProfile {
  id              String   @id @default(cuid())
  userId          String
  businessName    String?
  businessType    String
  revenueStage    String
  primaryChannel  String
  teamSize        String
  currentRevenue  Float
  confidenceScore Float
  metricSources   Json?
  lastUpdated     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model MetricSnapshot {
  id                  String   @id @default(cuid())
  userId              String
  revenue             Float
  revenueTrend7d      Float
  revenueTrend30d     Float
  leadCount           Int
  closeRate           Float
  averageDealValue    Float
  taskCompletionRate  Float
  followUpDelayHours  Float
  contentFrequency    Float
  burnoutRiskScore    Float
  timestamp           DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model RevenueHealthSnapshot {
  id                 String   @id @default(cuid())
  userId             String
  totalScore         Float
  componentScores    String   // JSON: { trend, conversion, leadConsistency, stability, followUp, leverage }
  primaryBottleneck  String
  revenueGap         Float
  interpretationBand String
  calculatedAt       DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model BottleneckAssessment {
  id                    String   @id @default(cuid())
  userId                String
  primaryBottleneck     String
  secondaryBottlenecks  String   // JSON array
  severityScore         Float
  calculatedAt          DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model BenchmarkProfile {
  id                    String @id @default(cuid())
  businessType          String
  revenueStage          String
  avgRevenueGrowth      Float
  avgCloseRate          Float
  avgFollowUpTime       Float
  avgLeadConsistency    Float
  commonToolStack       String // JSON array
  commonGrowthPatterns  String // JSON array

  @@unique([businessType, revenueStage])
}

model Insight {
  id                  String   @id @default(cuid())
  userId              String
  summary             String
  weeklyExecutionPlan String   // JSON array
  recommendedTools    String   // JSON array
  riskWarnings        String   // JSON array
  opportunitySignals  String   // JSON array
  createdAt           DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AffiliateTrigger {
  id                 String @id @default(cuid())
  bottleneckType     String
  recommendedTool    String
  reason             String
  metricGapThreshold Float
}

// ─── Prompt Templates ───

enum PromptVisibility {
  FREE
  PREMIUM
}

model PromptTemplate {
  id             String           @id @default(cuid())
  slug           String           @unique
  title          String
  category       String
  businessType   BusinessType?
  visibility     PromptVisibility @default(FREE)
  template       String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
}

// ─── Action Playbooks ───

model ActionPlaybook {
  id            String   @id @default(cuid())
  slug          String   @unique
  title         String
  category      String
  businessTypes String[]
  triggerRule    Json
  baseSteps     Json
  baseImpact    String
  effortLevel   String   // low | medium | high
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ─── Revenue Health Score (Phase 1 — manual inputs) ───

enum BusinessType {
  ecommerce
  saas
  service_agency
  creator
  local_business
}

model RevenueProfile {
  id                    String        @id @default(cuid())
  userId                String        @unique
  businessType          BusinessType?
  revenueMonthly        Float?
  grossMarginPct        Float?
  netProfitMonthly      Float?
  runwayMonths          Float?
  churnMonthlyPct       Float?
  conversionRatePct     Float?
  trafficMonthly        Float?
  avgOrderValue         Float?
  cac                   Float?
  ltv                   Float?
  opsHoursPerWeek       Float?
  fulfillmentDays       Float?
  supportTicketsPerWeek Float?
  usesPersonalCredit    String?  // 'yes', 'sometimes', 'no'
  connectedApps         String?  // JSON metadata for future integrations
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ─── AI Insight Cache ───

model AiInsight {
  id           String   @id @default(cuid())
  userId       String
  itemType     String   // "focus" | "tool"
  itemKey      String
  tier         String   // "preview" | "full"
  businessType String?
  profileHash  String
  contentJson  String   // JSON blob
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, itemType, itemKey, tier, profileHash])
}

model RevenueScoreSnapshot {
  id                   String   @id @default(cuid())
  userId               String
  score                Int
  pillarRevenue        Int
  pillarProfitability  Int
  pillarRetention      Int
  pillarAcquisition    Int
  pillarOps            Int
  pillarsJson          String   // Full pillar details JSON (reasons, levers)
  primaryRisk          String
  fastestLever         String
  nextStepsJson        String   // JSON array of recommendedNextSteps
  missingDataJson      String   // JSON array of missing keys
  createdAt            DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ─── Playbook Progress Tracking ───

model UserPlaybookProgress {
  id           String    @id @default(cuid())
  userId       String
  playbookSlug String
  stepIndex    Int
  completed    Boolean   @default(false)
  completedAt  DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, playbookSlug, stepIndex])
}

// ─── Credit Repair Referrals ───

model CreditReferral {
  id             String   @id @default(cuid())
  userId         String
  name           String
  email          String
  phone          String
  bestTimeToCall String?
  notes          String?  @db.VarChar(500)
  status         String   @default("pending") // pending, contacted, converted, declined
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user           User     @relation(fields: [userId], references: [id])
}

// ─── Weekly Revenue Tracker ───

model WeeklyLog {
  id        String   @id @default(cuid())
  userId    String
  weekOf    DateTime
  revenue   Float
  orders    Int?
  expenses  Float?
  aov       Float?
  profit    Float?
  margin    Float?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, weekOf])
}

// ─── Integration Framework ───

model Integration {
  id              String    @id @default(cuid())
  userId          String
  provider        String
  status          String    @default("connected")
  accessToken     String    @db.Text
  refreshToken    String?   @db.Text
  tokenExpiresAt  DateTime?
  storeDomain     String?
  externalId      String?
  scopes          String?
  lastSyncAt      DateTime?
  lastSyncStatus  String?
  lastSyncError   String?
  syncFrequency   String    @default("weekly")
  metadata        Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  syncLogs        SyncLog[]

  @@unique([userId, provider])
}

model SyncLog {
  id              String   @id @default(cuid())
  integrationId   String
  status          String
  metricsUpdated  Json?
  dataSnapshot    Json?
  pillarImpact    Json?
  error           String?
  duration        Int?
  createdAt       DateTime @default(now())

  integration     Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
}

model MetricHistory {
  id              String   @id @default(cuid())
  userId          String
  pillar          String
  score           Int
  metrics         Json
  source          String
  weekOf          DateTime
  createdAt       DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, pillar, weekOf])
}

// ─── Admin Metrics History ───

model AdminMetricsHistory {
  id                       String   @id @default(cuid())
  date                     DateTime @default(now())
  totalUsers               Int
  completedOnboarding      Int
  proSubscribers           Int
  creditReferrals          Int
  affiliateClicks          Int
  funnelSignedUp           Int
  funnelStartedDiagnosis   Int
  funnelCompletedOnboarding Int
  funnelActiveDashboard    Int

  @@unique([date])
}

// ─── User Feedback ───

model Feedback {
  id        String   @id @default(cuid())
  userId    String
  type      String   // bug, feature, general
  message   String
  pageUrl   String?
  status    String   @default("new") // new, reviewed, resolved
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ─── User Reviews ───

model Review {
  id        String   @id @default(cuid())
  userId    String
  rating    Int      // 1-5
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
}

// ─── Score Alerts (Phase 2) ───

model ScoreAlert {
  id        String   @id @default(cuid())
  userId    String
  type      String   // "pillar_drop" | "goal_hit" | "streak" | "data_stale"
  title     String
  message   String
  severity  String   // "info" | "warning" | "critical"
  pillar    String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
